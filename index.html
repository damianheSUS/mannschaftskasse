<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mannschaftskasse ‚Äì iOS Safe</title>
<style>:root {
  --bg:#fafbfd; --card:#ffffff; --ink:#0f1420; --muted:#64748b; --line:#e6e8ee;
  --radius:14px; --shadow:0 8px 30px rgba(15,20,32,.06); --accent:#8CC8E6;
}
*{box-sizing:border-box} html,body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Inter,Roboto,sans-serif;color:var(--ink);background:var(--bg)}
header{position:sticky;top:0;background:var(--card);padding:14px 16px;box-shadow:var(--shadow);display:flex;gap:12px;align-items:center;z-index:10}
h1{font-size:18px;margin:0;letter-spacing:.4px}
nav{display:flex;gap:8px;padding:10px;position:sticky;top:60px;background:var(--bg);z-index:9;flex-wrap:wrap}
nav button{border:1px solid var(--line);background:#fff;padding:10px 12px;border-radius:999px;font-weight:600}
nav button.active{background:var(--accent);color:#fff;border-color:transparent}
main{padding:16px;display:grid;gap:16px}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
input,select,textarea{width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:12px;background:#fff;font-size:16px}
.row{display:grid;gap:12px;grid-template-columns:1fr 1fr} .row3{display:grid;gap:12px;grid-template-columns:1fr 1fr 1fr}
.actions{display:grid;gap:12px;grid-template-columns:1fr 1fr} .primary{background:var(--accent);color:#fff;border:0;padding:12px 16px;border-radius:12px;font-weight:700}
.ghost{background:#f0f4f8;border:0;padding:12px 16px;border-radius:12px;font-weight:700}
.ghost.danger{background:#fde8e8;color:#b91c1c}
.table-actions{display:flex;gap:8px;flex-wrap:wrap}
.table-actions .ghost{padding:8px 12px;font-size:12px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--line);padding:10px;text-align:left;font-size:14px}
.hide{display:none} .small{font-size:12px;color:var(--muted)} .total{font-weight:800}
</style>
</head>
<body>
<header><h1>Mannschaftskasse</h1></header>
<nav id="tabs">
  <button data-tab="buchungen" class="active">Buchungen</button>
  <button data-tab="monate">Monate</button>
  <button data-tab="aktiv">Aktivierungen</button>
  <button data-tab="spieler">Spieler</button>
  <button data-tab="katalog">Strafenkatalog</button>
  <button data-tab="gesamt">Gesamt</button>
  <button data-tab="settings">Einstellungen</button>
</nav>
<main>
  <section id="tab-buchungen" class="card">
    <div class="row">
      <div><label>Spieler</label><select id="b_player"></select></div>
      <div><label>Strafe</label><select id="b_penalty"></select></div>
    </div>
    <div class="row">
      <div><label>Betrag (‚Ç¨)</label><input id="b_amount" type="number" inputmode="decimal" placeholder="0.00"></div>
      <div id="b_minutes_wrap" class="hide"><label>Minuten</label><input id="b_minutes" type="number" inputmode="numeric"></div>
    </div>
    <div><label>Notiz</label><input id="b_note" placeholder="optional"></div>
    <div class="actions" style="margin-top:12px;">
      <button class="primary" id="b_add">+ Hinzuf√ºgen</button>
      <button class="ghost hide" id="b_cancel">Abbrechen</button>
    </div>
  </section>

  <section class="card" id="b_stats">
    <div class="row">
      <div><label>Spieler-Filter</label><select id="b_filter_player"><option value="">Alle</option></select></div>
      <div><label>Monat</label><select id="b_filter_month"><option value="">Alle</option></select></div>
    </div>
    <table class="table" id="b_table"><thead><tr><th>Datum</th><th>Spieler</th><th>Strafe</th><th>Betrag</th><th>Notiz</th><th>Aktionen</th></tr></thead><tbody></tbody></table>
    <div class="row"><div>Gesamt (gefiltert)</div><div class="total" id="b_total">0,00 ‚Ç¨</div></div>
  </section>

  <section id="tab-monate" class="card hide">
    <div class="row">
      <div><label>Monat</label><select id="m_month"></select></div>
      <div><label>Beitr√§ge einrechnen?</label>
        <select id="m_include_fee"><option value="yes">Ja</option><option value="no">Nein</option></select>
      </div>
    </div>
    <div class="row3" style="margin-top:8px;">
      <div>Summe Strafen<br><span class="total" id="m_sum_fines">0,00 ‚Ç¨</span></div>
      <div>Summe Beitr√§ge<br><span class="total" id="m_sum_fees">0,00 ‚Ç¨</span></div>
      <div>Gesamt<br><span class="total" id="m_total">0,00 ‚Ç¨</span></div>
    </div>
    <h3>Pro Spieler</h3>
    <table class="table" id="m_table"><thead><tr><th>Spieler</th><th>Strafen</th><th>Beitr√§ge</th><th>Gesamt</th></tr></thead><tbody></tbody></table>
  </section>

  <section id="tab-aktiv" class="card hide">
    <div class="row">
      <div><label>Monat w√§hlen</label><select id="a_month"></select></div>
    </div>
    <table class="table" id="a_table"><thead><tr><th>Aktiv</th><th>Spieler</th></tr></thead><tbody></tbody></table>
    <p class="small">Beim ersten Aktiv-Schalten eines Spielers wird automatisch ein einmaliger <strong>Startbeitrag 10‚Ç¨</strong> als Strafe im gew√§hlten Monat verbucht.</p>
  </section>

  <section id="tab-spieler" class="card hide">
    <div class="row">
      <div><label>Neuer Spieler</label><input id="s_new" placeholder="Name"></div>
      <div><label>&nbsp;</label><button class="primary" id="s_add">+ Hinzuf√ºgen</button></div>
    </div>
    <table class="table" id="s_table"><thead><tr><th>Spieler</th><th></th></tr></thead><tbody></tbody></table>
  </section>

  <section id="tab-katalog" class="card hide">
    <div class="row">
      <div><label>Name</label><input id="k_name" placeholder="z.B. Zusp√§tkommen"></div>
      <div><label>Betrag (‚Ç¨) oder Satz</label><input id="k_amount" type="number" inputmode="decimal" placeholder="z.B. 5 oder 0.5"></div>
    </div>
    <div class="row">
      <div><label>Einheit</label>
        <select id="k_unit">
          <option value="">Fixbetrag</option>
          <option value="pro Minute">pro Minute</option>
          <option value="pro St√ºck">pro St√ºck</option>
        </select>
      </div>
      <div><label>Hinweis</label><input id="k_note" placeholder="optional (Spiel/Training)"></div>
    </div>
    <div class="actions" style="margin-top:12px;">
      <button class="primary" id="k_add">Speichern / hinzuf√ºgen</button>
    </div>
    <table class="table" id="k_table"><thead><tr><th>Strafe</th><th>Einheit</th><th>Standard</th><th></th></tr></thead><tbody></tbody></table>
  </section>

  <section id="tab-gesamt" class="card hide">
    <h3>Gesamt-Einnahmen</h3>
    <table class="table" id="g_table"><thead><tr><th>Monat</th><th>Strafen</th><th>Beitr√§ge</th><th>Gesamt</th></tr></thead><tbody></tbody></table>
    <div class="row"><div>Gesamtsumme</div><div class="total" id="g_total">0,00 ‚Ç¨</div></div>
  </section>

  <section id="tab-settings" class="card hide">
    <div class="actions">
      <button class="ghost" id="backup">Backup (alles JSON)</button>
      <button class="ghost" id="restore">Wiederherstellen</button>
      <button class="ghost" id="reset">Alles l√∂schen</button>
    </div>
  </section>
</main>
<script>
(function(){
'use strict';

// Polyfills
if(!NodeList.prototype.forEach){ NodeList.prototype.forEach = Array.prototype.forEach; }
function EURO(n){ try { return (n||0).toLocaleString('de-DE',{style:'currency',currency:'EUR'}); } catch(e){ return (Math.round((n||0)*100)/100).toFixed(2)+' ‚Ç¨'; } }
function ym(d){ var t=new Date(d); return t.getFullYear()+'-'+String(t.getMonth()+1).padStart(2,'0'); }
function ymFirstDayISO(ymstr){ var parts=ymstr.split('-'); var y=parseInt(parts[0],10); var m=parseInt(parts[1],10); return new Date(y, m-1, 1).toISOString(); }
function el(id){ return document.getElementById(id); }
function fillSelect(sel, arr){ sel.innerHTML=''; for(var i=0;i<arr.length;i++){ var o=document.createElement('option'); o.value=arr[i]; o.textContent=arr[i]; sel.appendChild(o);} }

function ensureSelectOption(select, value){
  if(!select || value===undefined || value===null) return;
  var options=[].slice.call(select.options||[]);
  var exists=options.some(function(opt){ return opt.value===value; });
  if(!exists){
    var o=document.createElement('option'); o.value=value; o.textContent=value; select.appendChild(o);
  }
}

function resetBookingForm(){
  editingEntry = null;
  var addBtn=el('b_add'); if(addBtn) addBtn.textContent='+ Hinzuf√ºgen';
  var cancelBtn=el('b_cancel'); if(cancelBtn) cancelBtn.classList.add('hide');
  var note=el('b_note'); if(note) note.value='';
  var minutes=el('b_minutes'); if(minutes) minutes.value='';
  var sel=el('b_penalty');
  if(sel){
    try{ sel.dispatchEvent(new Event('change')); }
    catch(e){ var evt=document.createEvent('Event'); evt.initEvent('change', true, true); sel.dispatchEvent(evt); }
  }
}

function cloneEntry(entry){
  var copy={};
  for(var k in entry){ if(Object.prototype.hasOwnProperty.call(entry,k)){ copy[k]=entry[k]; } }
  return copy;
}

function startEditEntry(entry){
  if(!entry) return;
  editingEntry = cloneEntry(entry);
  var playerSel=el('b_player'); ensureSelectOption(playerSel, entry.player); if(playerSel) playerSel.value=entry.player;
  var penaltySel=el('b_penalty'); ensureSelectOption(penaltySel, entry.penalty); if(penaltySel) penaltySel.value=entry.penalty;
  var amountField=el('b_amount'); if(amountField) amountField.value=Number(entry.amount||0).toFixed(2);
  var noteField=el('b_note'); if(noteField) noteField.value=entry.note||'';
  var minutesField=el('b_minutes'); if(minutesField) minutesField.value='';
  var addBtn=el('b_add'); if(addBtn) addBtn.textContent='Speichern';
  var cancelBtn=el('b_cancel'); if(cancelBtn) cancelBtn.classList.remove('hide');
  var opt = penaltySel && penaltySel.options && penaltySel.options[penaltySel.selectedIndex];
  var unit = ((opt && opt.getAttribute('data-unit'))||'').toLowerCase();
  el('b_minutes_wrap').classList.toggle('hide', unit.indexOf('minute')===-1);
  if(unit.indexOf('minute')>-1 && opt && opt.getAttribute('data-amount')){
    var base=parseFloat(opt.getAttribute('data-amount'));
    var currentAmount=Number(entry.amount||0);
    if(base>0){
      var minutesValue=currentAmount/base;
      if(isFinite(minutesValue) && minutesField){
        var rounded=Math.round(minutesValue*100)/100;
        minutesField.value = (rounded%1===0)? String(Math.round(rounded)): String(rounded);
      }
    }
  }
  if(amountField) amountField.focus();
}

// Data preset injected by Python
var PRESET_PLAYERS = ["Massi", "Nico Kessler", "Ajdin Cehadarevic", "Felix Thiele", "Gerrit Br√ºning", "Julian Berger", "Thorben Berger", "Vinzent Angerstein", "Tim Glettenberg", "Kai Fischersworring", "Damit Heine", "Nico W√ºnnenberg", "Mattis Birkel", "Marc G√ºnter", "Maxi Plate", "Andre Ockenga", "Apo Bakas", "Corbi aus den Siepen", "Marijan", "Fabi ", "Hamoud ", "Maurice Paul", "Maurice Hundenborn", "Nils Glettenberg"];
var PRESET_CATALOG = [{"name": "Sieg", "betrag": 5.0, "einheit": "fix", "hinweis": null}, {"name": "Gegentor", "betrag": 0.5, "einheit": "fix", "hinweis": "‚Ç¨/Gegentor"}, {"name": "Gelbe Karte (Unsportlichkeit)", "betrag": 15.0, "einheit": "fix", "hinweis": null}, {"name": "Gelb-rote Karte (Unsportlichkeit)", "betrag": 30.0, "einheit": "fix", "hinweis": null}, {"name": "Rote Karte", "betrag": 10.0, "einheit": "fix", "hinweis": null}, {"name": "Rote Karte (Unsportlichkeit)", "betrag": 75.0, "einheit": "fix", "hinweis": "75‚Ç¨ + üç∫"}, {"name": "Zu sp√§t (Training)", "betrag": 0.5, "einheit": "pro Minute", "hinweis": "‚Ç¨/Minute"}, {"name": "Zu sp√§t (Spiel)", "betrag": 1.0, "einheit": "pro Minute", "hinweis": "‚Ç¨/Minute"}, {"name": "Unentschuldigtes Fehlen (Training)", "betrag": 10.0, "einheit": "fix", "hinweis": null}, {"name": "Unentschuldigtes Fehlen (Spiel)", "betrag": 75.0, "einheit": "fix", "hinweis": null}, {"name": "Falscher Einwurf", "betrag": 3.0, "einheit": "fix", "hinweis": null}, {"name": "Ball √ºber'n Zaun", "betrag": 1.5, "einheit": "fix", "hinweis": null}, {"name": "Wildpinkeln", "betrag": 5.0, "einheit": "fix", "hinweis": null}, {"name": "Toilettengang w√§hrend Einheit", "betrag": 2.0, "einheit": "fix", "hinweis": null}, {"name": "Keine 20er", "betrag": 1.0, "einheit": "fix", "hinweis": null}, {"name": "20er-Runde", "betrag": 1.0, "einheit": "fix", "hinweis": null}, {"name": "Beini", "betrag": 1.0, "einheit": "fix", "hinweis": null}, {"name": "Vergessene Tasche", "betrag": 20.0, "einheit": "fix", "hinweis": null}, {"name": "Vergessene Fu√üballschuhe", "betrag": 10.0, "einheit": "fix", "hinweis": null}, {"name": "Vergessene Laufschuhe", "betrag": 5.0, "einheit": "fix", "hinweis": null}, {"name": "Vergessene Schienbeinschoner", "betrag": 3.0, "einheit": "fix", "hinweis": null}, {"name": "Vergessenes sonstiges Teil", "betrag": 1.0, "einheit": "fix", "hinweis": null}, {"name": "Ungeputzte Fu√üballschuhe", "betrag": 5.0, "einheit": "fix", "hinweis": null}, {"name": "Trikot/Hose/Stutzen falsch in Trikottasche", "betrag": 3.0, "einheit": "fix", "hinweis": null}, {"name": "Pinkeln in der Dusche", "betrag": 5.0, "einheit": "fix", "hinweis": null}, {"name": "Abhauen ohne Hand geben", "betrag": 3.0, "einheit": "fix", "hinweis": null}, {"name": "Rauchen nach Treffpunkt", "betrag": 3.0, "einheit": "fix", "hinweis": null}, {"name": "Rauchen im Trikot", "betrag": 3.0, "einheit": "fix", "hinweis": null}, {"name": "Trinken im Trikot", "betrag": 3.0, "einheit": "fix", "hinweis": null}, {"name": "Bier Bunkern", "betrag": 3.0, "einheit": "fix", "hinweis": null}, {"name": "Angetrunken", "betrag": 3.0, "einheit": "fix", "hinweis": null}, {"name": "Handy klingelt/vibriert", "betrag": 3.0, "einheit": "fix", "hinweis": null}, {"name": "Bier versch√ºttet", "betrag": 2.0, "einheit": "fix", "hinweis": null}, {"name": "M√ºlleimer nicht getroffen", "betrag": 2.0, "einheit": "fix", "hinweis": null}, {"name": "Nicht duschen gehen", "betrag": 1.0, "einheit": "fix", "hinweis": null}, {"name": "Lichtfehler", "betrag": 1.0, "einheit": "fix", "hinweis": null}, {"name": "Falsche Gruppe", "betrag": 1.0, "einheit": "fix", "hinweis": null}];

// Storage (IndexedDB with localStorage fallback)
var DBNAME='mkasse-iossafe', DBVER=1, db=null, useLocal=false;
var editingEntry=null;

function openDB(cb){
  if(!window.indexedDB){ useLocal=true; return cb(); }
  var req=indexedDB.open(DBNAME, DBVER);
  req.onupgradeneeded=function(){ var d=req.result;
    ['entries','fees','players','catalog','active','meta'].forEach(function(s){
      if(!d.objectStoreNames.contains(s)) d.createObjectStore(s,{keyPath:'id', autoIncrement:true});
    });
  };
  req.onsuccess=function(){ db=req.result; cb(); };
  req.onerror=function(){ useLocal=true; cb(); };
}

function lget(key){ try{ return JSON.parse(localStorage.getItem(key)||'[]'); }catch(e){ return []; } }
function lset(key, arr){ localStorage.setItem(key, JSON.stringify(arr||[])); }
function lsAll(store){ return lget('mk_'+store); }
function lsAdd(store, obj){ var arr=lsAll(store); var id=(arr.length? (arr[arr.length-1].id||0)+1 : 1); obj.id=id; arr.push(obj); lset('mk_'+store, arr); return id; }
function lsPut(store, obj){ var arr=lsAll(store); for(var i=0;i<arr.length;i++){ if(arr[i].id===obj.id){ arr[i]=obj; break; } } lset('mk_'+store, arr); }
function lsDel(store, id){ var arr=lsAll(store).filter(function(x){ return x.id!==id; }); lset('mk_'+store, arr); }
function lsClear(store){ lset('mk_'+store, []); }

function getAll(store, cb){
  if(useLocal){ return cb(lsAll(store)); }
  var tx=db.transaction(store).objectStore(store).getAll();
  tx.onsuccess=function(){ cb(tx.result||[]); };
  tx.onerror=function(){ cb([]); };
}
function add(store, obj, cb){
  if(useLocal){ var id=lsAdd(store, obj); return cb && cb(id); }
  var t=db.transaction(store,'readwrite').objectStore(store).add(obj);
  t.onsuccess=function(){ cb && cb(t.result); };
}
function put(store, obj, cb){
  if(useLocal){ lsPut(store,obj); return cb && cb(); }
  var t=db.transaction(store,'readwrite').objectStore(store).put(obj);
  t.onsuccess=function(){ cb && cb(); };
}
function delItem(store, id, cb){
  if(useLocal){ lsDel(store,id); return cb && cb(); }
  var t=db.transaction(store,'readwrite').objectStore(store).delete(id);
  t.onsuccess=function(){ cb && cb(); };
}
function clearStore(store, cb){
  if(useLocal){ lsClear(store); return cb && cb(); }
  var t=db.transaction(store,'readwrite').objectStore(store).clear();
  t.onsuccess=function(){ cb && cb(); };
}

function ensureInitial(cb){
  getAll('players', function(pls){
    if(pls.length===0 && PRESET_PLAYERS.length){
      var addNext=function(i){ if(i>=PRESET_PLAYERS.length) return next(); add('players',{name:PRESET_PLAYERS[i]}, function(){ addNext(i+1); }); };
      addNext(0);
    } else { next(); }
    function next(){
      getAll('catalog', function(cat){
        if(cat.length===0 && PRESET_CATALOG.length){
          var addC=function(i){ if(i>=PRESET_CATALOG.length) return cb(); 
            var p=PRESET_CATALOG[i]||{};
            add('catalog',{name:p.name, betrag:p.betrag||0, einheit:p.einheit||'', hinweis:p.hinweis||''}, function(){ addC(i+1); });
          }; addC(0);
        } else { cb(); }
      });
    }
  });
}

// Tabs
function setTab(name){
  var buttons=document.querySelectorAll('nav button');
  for(var i=0;i<buttons.length;i++){ buttons[i].classList.toggle('active', buttons[i].getAttribute('data-tab')===name); }
  var ids=['buchungen','monate','aktiv','spieler','katalog','gesamt','settings'];
  for(i=0;i<ids.length;i++){ el('tab-'+ids[i]).classList.toggle('hide', ids[i]!==name); }
  if(name==='buchungen') refreshBookings();
  if(name==='monate') refreshMonths();
  if(name==='aktiv') refreshActive();
  if(name==='spieler') refreshPlayers();
  if(name==='katalog') refreshCatalog();
  if(name==='gesamt') refreshOverall();
}

// Refresh functions
function refreshPlayers(){
  getAll('players', function(pls){
    var names = pls.map(function(p){ return p.name; });
    fillSelect(el('b_player'), names);
    var f = el('b_filter_player'); f.innerHTML='<option value="">Alle</option>';
    names.forEach(function(n){ var o=document.createElement('option'); o.value=n; o.textContent=n; f.appendChild(o); });
    var tbody=el('s_table').querySelector('tbody'); tbody.innerHTML='';
    pls.forEach(function(p){
      var tr=document.createElement('tr');
      tr.innerHTML = '<td>'+p.name+'</td><td><button class="ghost" data-del="'+p.id+'">L√∂schen</button></td>';
      tbody.appendChild(tr);
    });
    [].slice.call(tbody.querySelectorAll('button[data-del]')).forEach(function(btn){
      btn.onclick=function(){ delItem('players', Number(btn.getAttribute('data-del')), function(){ refreshPlayers(); refreshActive(); }); };
    });
  });
}
function refreshCatalog(){
  getAll('catalog', function(cat){
    var sel = el('b_penalty'); sel.innerHTML='';
    cat.forEach(function(p){
      var o=document.createElement('option');
      o.value=p.name; o.textContent = p.name + (p.einheit?(' ('+p.einheit+')'):'');
      o.setAttribute('data-unit', p.einheit||'');
      o.setAttribute('data-amount', p.betrag||0);
      sel.appendChild(o);
    });
    sel.onchange=function(){
      var opt=sel.options[sel.selectedIndex]; var unit=(opt.getAttribute('data-unit')||'').toLowerCase();
      el('b_minutes_wrap').classList.toggle('hide', unit.indexOf('minute')===-1);
      var amt = opt.getAttribute('data-amount'); el('b_amount').value = amt? Number(amt).toFixed(2):'';
    };
    var tbody=el('k_table').querySelector('tbody'); tbody.innerHTML='';
    cat.forEach(function(p){
      var tr=document.createElement('tr');
      tr.innerHTML = '<td>'+p.name+'</td><td>'+(p.einheit||'fix')+'</td><td>'+((p.betrag||0).toFixed(2))+' ‚Ç¨</td><td><button class="ghost" data-del="'+p.id+'">L√∂schen</button></td>';
      tbody.appendChild(tr);
    });
    [].slice.call(tbody.querySelectorAll('button[data-del]')).forEach(function(btn){
      btn.onclick=function(){ delItem('catalog', Number(btn.getAttribute('data-del')), function(){ refreshCatalog(); }); };
    });
  });
}
function refreshBookings(){
  getAll('entries', function(entries){
    var months = entries.map(function(e){ return ym(e.date); }).filter(function(v,i,a){ return a.indexOf(v)===i; }).sort().reverse();
    var monthSel=el('b_filter_month');
    var prevMonth=monthSel.value;
    monthSel.innerHTML='<option value="">Alle</option>';
    months.forEach(function(m){ var o=document.createElement('option'); o.value=m; o.textContent=m; monthSel.appendChild(o); });
    if(prevMonth){ monthSel.value=prevMonth; if(monthSel.value!==prevMonth) monthSel.value=''; }
    var fp=el('b_filter_player').value;
    var fm=monthSel.value;
    var filtered = entries.filter(function(e){ return (!fp || e.player===fp) && (!fm || ym(e.date)===fm); });
    filtered.sort(function(a,b){ return new Date(b.date)-new Date(a.date); });
    var tbody=el('b_table').querySelector('tbody'); tbody.innerHTML='';
    var total=0;
    filtered.forEach(function(e){
      total += Number(e.amount||0);
      var tr=document.createElement('tr');
      tr.innerHTML = '<td>'+new Date(e.date).toLocaleString('de-DE')+'</td><td>'+e.player+'</td><td>'+e.penalty+'</td><td>'+((e.amount||0).toFixed(2))+'</td><td>'+(e.note||'')+'</td>'+
        '<td><div class="table-actions"><button class="ghost" data-edit="'+e.id+'">Bearbeiten</button><button class="ghost danger" data-del="'+e.id+'">L√∂schen</button></div></td>';
      tbody.appendChild(tr);
      var editBtn=tr.querySelector('button[data-edit]');
      if(editBtn){ editBtn.onclick=function(){ startEditEntry(e); }; }
      var delBtn=tr.querySelector('button[data-del]');
      if(delBtn){ delBtn.onclick=function(){
        if(!confirm('Eintrag wirklich l√∂schen?')) return;
        delItem('entries', Number(e.id), function(){
          if(editingEntry && editingEntry.id===e.id) resetBookingForm();
          refreshBookings(); refreshMonths(); refreshOverall();
        });
      }; }
    });
    el('b_total').textContent = EURO(total);
  });
}
function monthListAroundToday(){
  var now=new Date(); var y=now.getFullYear(); var m=now.getMonth()+1;
  var out=[]; for(var i=-6;i<=6;i++){ var d=new Date(y, m-1+i); out.push(d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')); }
  return out;
}
function refreshActive(){
  getAll('players', function(pls){
    var names=pls.map(function(p){ return p.name; }).sort();
    var months=monthListAroundToday();
    var sel=el('a_month'); sel.innerHTML=''; months.forEach(function(v){ var o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
    if(!sel.value && months.length){ sel.value=months[6]; }
    getAll('active', function(act){
      var map={}; act.forEach(function(a){ map[a.ym+'|'+a.player]=a; });
      var tbody=el('a_table').querySelector('tbody'); tbody.innerHTML='';
      var cur=el('a_month').value;
      names.forEach(function(name){
        var key=cur+'|'+name; var isActive = !!(map[key] && map[key].active);
        var tr=document.createElement('tr');
        tr.innerHTML = '<td><input type="checkbox" data-player="'+name+'" '+(isActive?'checked':'')+'></td><td>'+name+'</td>';
        tbody.appendChild(tr);
      });
      [].slice.call(tbody.querySelectorAll('input[type=checkbox]')).forEach(function(ch){
        ch.onchange=function(){
          var player=ch.getAttribute('data-player'); var ymv=el('a_month').value; var val=ch.checked;
          // upsert
          var existing = null; act.forEach(function(a){ if(a.player===player && a.ym===ymv) existing=a; });
          if(existing){ existing.active=val; put('active', existing, function(){}); }
          else { add('active',{ym:ymv, player:player, active:val}, function(){}); }
          // meta for first-time activation
          getAll('meta', function(meta){
            var key='activation_'+player;
            var was = null; meta.forEach(function(m){ if(m.key===key) was=m; });
            if(val && !was){
              add('entries', {player:player, penalty:'Startbeitrag', amount:10.00, note:'Einmalig bei erster Aktivierung', date: ymFirstDayISO(ymv)}, function(){
                add('meta', {key:key, value: ymv}, function(){
                  alert(player+': Startbeitrag 10‚Ç¨ im Monat '+ymv+' verbucht.');
                  refreshBookings(); refreshMonths(); refreshOverall();
                });
              });
            } else {
              refreshMonths();
            }
          });
        };
      });
    });
  });
}
function refreshMonths(){
  getAll('entries', function(entries){
    getAll('fees', function(fees){
      getAll('active', function(active){
        var months = entries.map(function(e){ return ym(e.date); })
          .concat(active.map(function(a){ return a.ym; }))
          .filter(function(v,i,a){ return a.indexOf(v)===i; }).sort().reverse();
        var sel=el('m_month'); sel.innerHTML=''; months.forEach(function(m){ var o=document.createElement('option'); o.value=m; o.textContent=m; sel.appendChild(o); });
        if(!sel.value && months.length){ sel.value=months[0]; }
        var current = el('m_month').value;
        var activePlayers = {};
        active.forEach(function(a){ if(a.ym===current && a.active) activePlayers[a.player]=true; });
        var monthEntries = entries.filter(function(e){ return ym(e.date)===current && !!activePlayers[e.player]; });
        var sumFines = monthEntries.reduce(function(s,e){ return s + Number(e.amount||0); }, 0);
        var sumFees = fees.filter(function(f){ return ym(f.date)===current; }).reduce(function(s,e){ return s + Number(e.amount||0); }, 0);
        var include = el('m_include_fee').value !== 'no';
        el('m_sum_fines').textContent = EURO(sumFines);
        el('m_sum_fees').textContent = EURO(sumFees);
        el('m_total').textContent = EURO(include? (sumFines+sumFees): sumFines);
        // per player
        var map={};
        monthEntries.forEach(function(e){ if(!map[e.player]) map[e.player]={fines:0, fees:0}; map[e.player].fines += Number(e.amount||0); });
        fees.filter(function(f){ return ym(f.date)===current; }).forEach(function(f){ if(!map[f.player]) map[f.player]={fines:0, fees:0}; map[f.player].fees += Number(f.amount||0); });
        var tbody=el('m_table').querySelector('tbody'); tbody.innerHTML='';
        Object.keys(map).sort().forEach(function(name){
          var fines=map[name].fines||0, feesv=map[name].fees||0, tot = include? (fines+feesv) : fines;
          var tr=document.createElement('tr');
          tr.innerHTML = '<td>'+name+'</td><td>'+fines.toFixed(2)+'</td><td>'+feesv.toFixed(2)+'</td><td>'+tot.toFixed(2)+'</td>';
          tbody.appendChild(tr);
        });
      });
    });
  });
}
function refreshOverall(){
  getAll('entries', function(entries){
    getAll('fees', function(fees){
      var months = entries.map(function(e){ return ym(e.date); }).concat(fees.map(function(f){ return ym(f.date); }));
      months = months.filter(function(v,i,a){ return a.indexOf(v)===i; }).sort();
      var tbody=el('g_table').querySelector('tbody'); tbody.innerHTML='';
      var grand=0;
      months.forEach(function(m){
        var sf = entries.filter(function(e){ return ym(e.date)===m; }).reduce(function(s,e){ return s+Number(e.amount||0); }, 0);
        var fe = fees.filter(function(f){ return ym(f.date)===m; }).reduce(function(s,e){ return s+Number(e.amount||0); }, 0);
        var tot = sf+fe; grand+=tot;
        var tr=document.createElement('tr'); tr.innerHTML = '<td>'+m+'</td><td>'+sf.toFixed(2)+'</td><td>'+fe.toFixed(2)+'</td><td>'+tot.toFixed(2)+'</td>';
        tbody.appendChild(tr);
      });
      el('g_total').textContent = EURO(grand);
    });
  });
}

// Bind handlers
function bindHandlers(){
  [].slice.call(document.querySelectorAll('nav button')).forEach(function(b){ b.onclick=function(){ setTab(b.getAttribute('data-tab')); }; });
  el('b_add').onclick = function(){
    var player=el('b_player').value;
    var sel=el('b_penalty'); var pen=sel.value;
    var opt=sel.options[sel.selectedIndex];
    var unit=(opt && opt.getAttribute('data-unit')||'').toLowerCase();
    var amountInput=(el('b_amount').value||'');
    var base=parseFloat(amountInput.replace(',','.'));
    var minutesRaw=(el('b_minutes').value||'').trim();
    var mins=minutesRaw? parseFloat(minutesRaw.replace(',','.')): NaN;
    if(isNaN(base)){ alert('Betrag fehlt.'); return; }
    var amount = base;
    if(unit.indexOf('minute')>-1 && minutesRaw){ amount = (isNaN(mins)?0:mins) * base; }
    var payload={player:player, penalty:pen, amount: Math.round(amount*100)/100, note: el('b_note').value.trim()};
    if(editingEntry){
      payload.id=editingEntry.id;
      payload.date=editingEntry.date;
      put('entries', payload, function(){
        resetBookingForm();
        refreshBookings(); refreshMonths(); refreshOverall();
      });
    } else {
      payload.date=new Date().toISOString();
      add('entries', payload, function(){
        resetBookingForm();
        refreshBookings(); refreshMonths(); refreshOverall();
      });
    }
  };
  el('b_cancel').onclick = function(){ resetBookingForm(); };
  el('b_filter_player').onchange=refreshBookings; el('b_filter_month').onchange=refreshBookings;
  el('s_add').onclick = function(){ var n=el('s_new').value.trim(); if(!n) return; add('players',{name:n}, function(){ el('s_new').value=''; refreshPlayers(); refreshActive(); }); };
  el('k_add').onclick = function(){
    var name = el('k_name').value.trim(); if(!name) return;
    var amount = parseFloat((el('k_amount').value||'0').replace(',','.'))||0;
    var unit = el('k_unit').value; var note = el('k_note').value.trim();
    add('catalog', {name:name, betrag:amount, einheit:unit, hinweis:note}, function(){
      el('k_name').value=''; el('k_amount').value=''; el('k_note').value=''; refreshCatalog();
    });
  };
  el('a_month').onchange=refreshActive;
  el('m_month').onchange=refreshMonths; el('m_include_fee').onchange=refreshMonths;
  el('backup').onclick = function(){
    var stores=['entries','fees','players','catalog','active','meta'], data={}, left=stores.length;
    stores.forEach(function(s){ getAll(s,function(items){ data[s]=items; left--; if(left===0){ var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='backup_mkasse_iossafe.json'; a.click(); URL.revokeObjectURL(url);} }); });
  };
  el('restore').onclick = function(){
    var inp=document.createElement('input'); inp.type='file'; inp.accept='.json,application/json';
    inp.onchange=function(){ var file=inp.files[0]; if(!file) return; var r=new FileReader(); r.onload=function(){
      try{
        var data=JSON.parse(r.result||'{}'); var stores=['entries','fees','players','catalog','active','meta']; var done=0;
        var clearNext=function(i){ if(i>=stores.length) return fill(); clearStore(stores[i], function(){ clearNext(i+1); }); };
        clearNext(0);
        function fill(){
          function addList(store, arr, i, cb){ if(i>=arr.length) return cb(); add(store, arr[i], function(){ addList(store, arr, i+1, cb); }); }
          var seq=[
            function(n){ addList('players', data.players||[], 0, n); },
            function(n){ addList('catalog', data.catalog||[], 0, n); },
            function(n){ addList('entries', data.entries||[], 0, n); },
            function(n){ addList('fees', data.fees||[], 0, n); },
            function(n){ addList('active', data.active||[], 0, n); },
            function(n){ addList('meta', data.meta||[], 0, n); }
          ];
          var step=function(k){ if(k>=seq.length) return doneAll(); seq[k](function(){ step(k+1); }); };
          step(0);
        }
        function doneAll(){ refreshPlayers(); refreshCatalog(); refreshBookings(); refreshActive(); refreshMonths(); refreshOverall(); alert('Backup wiederhergestellt.'); }
      }catch(e){ alert('Fehler beim Einlesen der Datei.'); }
    }; r.readAsText(file); };
    inp.click();
  };
  el('reset').onclick = function(){ if(confirm('Wirklich ALLES l√∂schen?')){ ['entries','fees','players','catalog','active','meta'].forEach(function(s){ clearStore(s,function(){}); }); ensureInitial(function(){ refreshPlayers(); refreshCatalog(); refreshBookings(); refreshActive(); refreshMonths(); refreshOverall(); }); } };
}

// Build DOM (static HTML is below), then init
document.addEventListener('DOMContentLoaded', function(){
  openDB(function(){
    ensureInitial(function(){
      refreshPlayers();
      refreshCatalog();
      refreshBookings();
      refreshActive();
      refreshMonths();
      refreshOverall();
      bindHandlers();
      setTab('buchungen');
    });
  });
});

})();
</script>
</body>
</html>
